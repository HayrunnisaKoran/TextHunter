@{
    ViewData["Title"] = "Ayarlar";
}

<div class="container mt-5">
    <h2 class="fw-bold mb-4">⚙️ Uygulama Ayarları</h2>

    <form asp-action="UpdateSettings" method="post" id="settingsForm">
        <div class="list-group shadow-sm rounded-4">
            <div class="list-group-item p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">Karanlık Mod</h5>
                        <p class="mb-0 text-muted">Arayüzü koyu renk temasına çevirir.</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="DarkMode" role="switch" id="darkModeSwitch" value="true">
                        <input type="hidden" name="DarkMode" value="false">
                    </div>
                </div>
            </div>
            <div class="list-group-item p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1 fw-bold">E-posta Bildirimleri</h5>
                        <p class="mb-0 text-muted">Analiz raporlarını e-posta ile gönder.</p>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="EmailNotifications" role="switch" id="emailNotificationsSwitch" value="true">
                        <input type="hidden" name="EmailNotifications" value="false">
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 d-grid">
            <button type="submit" class="btn btn-primary btn-lg">Ayarları Kaydet</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Karanlık mod ve E-posta bildirimleri switch'leri için anında uygulama
        document.addEventListener('DOMContentLoaded', function() {
            // Karanlık Mod Switch
            const darkModeSwitch = document.getElementById('darkModeSwitch');
            
            if (darkModeSwitch) {
                // Sayfa yüklendiğinde localStorage'dan kontrol et
                const savedDarkMode = localStorage.getItem('darkMode') === 'true';
                if (savedDarkMode) {
                    darkModeSwitch.checked = true;
                    document.body.classList.add('dark-mode');
                }

                // Checkbox değiştiğinde anında uygula
                darkModeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        document.body.classList.add('dark-mode');
                        localStorage.setItem('darkMode', 'true');
                    } else {
                        document.body.classList.remove('dark-mode');
                        localStorage.setItem('darkMode', 'false');
                    }
                });
            }

            // E-posta Bildirimleri Switch
            const emailNotificationsSwitch = document.getElementById('emailNotificationsSwitch');
            
            if (emailNotificationsSwitch) {
                // Sayfa yüklendiğinde localStorage'dan kontrol et
                const savedEmailNotifications = localStorage.getItem('emailNotifications');
                if (savedEmailNotifications !== null) {
                    emailNotificationsSwitch.checked = savedEmailNotifications === 'true';
                } else {
                    // localStorage yoksa session'dan kontrol et (ilk yükleme)
                    const sessionValue = '@(Context.Session.GetString("EmailNotifications") ?? "false")';
                    if (sessionValue === 'true') {
                        emailNotificationsSwitch.checked = true;
                        localStorage.setItem('emailNotifications', 'true');
                    } else {
                        emailNotificationsSwitch.checked = false;
                        localStorage.setItem('emailNotifications', 'false');
                    }
                }

                // Checkbox değiştiğinde localStorage'a kaydet
                emailNotificationsSwitch.addEventListener('change', function() {
                    localStorage.setItem('emailNotifications', this.checked ? 'true' : 'false');
                });
            }

            // Form submit edilmeden önce checkbox durumlarını kontrol et
            const settingsForm = document.getElementById('settingsForm');
            if (settingsForm) {
                settingsForm.addEventListener('submit', function(e) {
                    // Checkbox'ların durumunu hidden input'lara yaz
                    const darkModeHidden = settingsForm.querySelector('input[name="DarkMode"][type="hidden"]');
                    const emailNotificationsHidden = settingsForm.querySelector('input[name="EmailNotifications"][type="hidden"]');
                    
                    if (darkModeSwitch && darkModeSwitch.checked) {
                        if (darkModeHidden) darkModeHidden.disabled = true;
                    }
                    
                    if (emailNotificationsSwitch && emailNotificationsSwitch.checked) {
                        if (emailNotificationsHidden) emailNotificationsHidden.disabled = true;
                    }
                });
            }
        });
    </script>
}